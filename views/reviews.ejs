<div id="createEditModal" class="z-50 absolute flex justify-center top-0 w-screen h-screen select-none hidden">
    <div class="flex justify-center top-0 w-screen h-screen z-50">
        <div class="blackModal absolute top-0  w-full h-full bg-black opacity-80 z-50"></div>
        <div class="absolute z-50 opacity-100 w-2/5">
            <div class="absolute w-full bg-white rounded top-[50vh] -translate-y-[75%] px-12 py-8">
                <div id="createEditHeader" class="text-3xl mb-4 my-auto font-semibold">
                    Modify the respective columns
                </div>
                <div class="flex flex-col mb-5">
                    <div class="w-full">
                        <div class="mb-1">
                            Book
                        </div>
                        <div class="relative z-30">
                            <button id="dropdownToggle" class="w-full text-left border px-2 py-1 border-black">
                                <div>
                                    <span id="authorString" class="text-base text-left">Select the Book..</span>
                                </div>
                            </button>
                            <ul id="dropdownMenu" class="absolute left-0 w-full mt-2 bg-white rounded shadow-lg hidden z-50 overflow-y-auto max-h-36">
                                <% allBooks.forEach((element, index) => { %>
                                    <li><a id="<%= element._id %>" class="authorOption block px-4 text-gray-800 hover:bg-gray-200" ><%= element.name %></a></li>
                                <% }) %>
                            </ul>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <div class="mb-1">
                            Review
                        </div>
                        <div>
                            <textarea id="editReview" class="border border-black w-full px-2 py-1"></textarea>
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <div class="mb-1">
                            Score
                        </div>
                        <div>
                            <input id="editScore" class="border border-black w-full px-2 py-1" type="number">
                        </div>
                    </div>
                    <div class="flex flex-col">
                        <div class="mb-1">
                            Up-Votes
                        </div>
                        <div>
                            <input id="editUpVotes" class="border border-black w-full px-2 py-1" type="number">
                        </div>
                    </div>
                </div>
                <div class="flex justify-between w-full">
                    <div class="w-2/5">
                        <button class="quitModal w-full border border-secundary bg-gray-50 hover:bg-gray-100 hover:border-white py-2 px-6 text-center text-lg font-medium rounded-lg select-none">
                            No, cancel pls
                        </button>
                    </div>
                    <div id="confirmEdit" class="w-2/5">
                        <button class="w-full border border-secundary bg-gray-50 hover:bg-gray-100 hover:border-white py-2 px-6 text-center text-lg font-medium rounded-lg select-none">
                            Yes, edit
                        </button>
                    </div>
                    <div id="confirmCreate" class="w-2/5">
                        <button class="w-full border border-secundary bg-gray-50 hover:bg-gray-100 hover:border-white py-2 px-6 text-center text-lg font-medium rounded-lg select-none">
                            Create
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="bg-slate-200 h-[90vh] bg-opacity-50 select-none">
    <div class="flex justify-between w-5/6 text-5xl mx-auto font-semibold italic text-center pt-5">
        <div>
            Reviews CRUD
        </div>
        <div id="createButton" class="flex border-2 border-black hover:bg-white px-2 rounded-lg cursor-pointer">
            <div class="mx-2 text-3xl my-auto not-italic">
                Add new row
            </div>
            <div>
                <div class=" rounded-full p-2">
                    <div class="h-9 w-9">
                        <svg viewBox="0 0 32 32">
                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" sketch:type="MSPage">
                                <g sketch:type="MSLayerGroup" transform="translate(-362.000000, -1037.000000)" fill="#000000">
                                    <path d="M390,1049 L382,1049 L382,1041 C382,1038.79 380.209,1037 378,1037 C375.791,1037 374,1038.79 374,1041 L374,1049 L366,1049 C363.791,1049 362,1050.79 362,1053 C362,1055.21 363.791,1057 366,1057 L374,1057 L374,1065 C374,1067.21 375.791,1069 378,1069 C380.209,1069 382,1067.21 382,1065 L382,1057 L390,1057 C392.209,1057 394,1055.21 394,1053 C394,1050.79 392.209,1049 390,1049" sketch:type="MSShapeGroup"></path>
                                </g>
                            </g>
                        </svg>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="w-5/6 h-[75vh] mx-auto overflow-y-auto mt-5">
        <table>
            <thead>
                <tr class=" sticky top-0 w-5/6 h-10 bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                    <th class="w-2/12 py-3 px-6 text-left">Book Name</th>
                    <th class="w-7/12 py-3 px-6 text-left">Review</th>
                    <th class="w-1/12 py-3 px-6 text-left">Score</th>
                    <th class="w-1/12 py-3 px-6 text-left">Up-votes</th>
                    <th class="w-1/12 py-3 px-6 text-left"></th>
                </tr>
            </thead>
            <tbody class="text-gray-600 text-sm font-light">
                <% allReviews.forEach((element, index) => { %>
                    <tr class=" border-b border-gray-100 hover:bg-gray-200 <%= (index % 2 === 0) ? 'bg-white' : 'bg-gray-50' %>">
                        <td class="w-2/12 py-3 px-6 whitespace-nowrap">
                            <span class="font-medium"><%= element.book.name %></span>
                        </td>
                        <td class="w-7/12 py-3 px-6">
                            <span><%= element.review %></span>
                        </td>
                        <td class="w-1/12 py-3 px-6">
                            <span><%= element.score %></span>
                        </td>
                        <td class="w-1/12 py-3 px-6">
                            <span><%= element.up_votes %></span>
                        </td>
                        <td class="w-1/12 py-3 px-6">
                            <div class="flex justify-between px-2">
                                <div name="<%=element.book.name%>" review="<%=element.review%>" score="<%=element.score%>" up_votes="<%=element.up_votes%>" book="<%= element.book.name %>" book_id="<%=element.book._id%>" id="<%= element._id %>" class="editSvg w-9 h-9 cursor-pointer">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path d="M18.3785 8.44975L11.4637 15.3647C11.1845 15.6439 10.8289 15.8342 10.4417 15.9117L7.49994 16.5L8.08829 13.5582C8.16572 13.1711 8.35603 12.8155 8.63522 12.5363L15.5501 5.62132M18.3785 8.44975L19.7927 7.03553C20.1832 6.64501 20.1832 6.01184 19.7927 5.62132L18.3785 4.20711C17.988 3.81658 17.3548 3.81658 16.9643 4.20711L15.5501 5.62132M18.3785 8.44975L15.5501 5.62132" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M5 20H19" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div id="<%=element._id%>" class="deleteSvg w-8 h-8 cursor-pointer">
                                    <svg viewBox="0 0 24 24" fill="none">
                                        <path d="M10 11V17" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M14 11V17" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M4 7H20" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M6 7H12H18V18C18 19.6569 16.6569 21 15 21H9C7.34315 21 6 19.6569 6 18V7Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        <path d="M9 5C9 3.89543 9.89543 3 11 3H13C14.1046 3 15 3.89543 15 5V7H9V5Z" stroke="#000000" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                            </div>
                        </td>
                    </tr>
                <% }) %>
            </tbody>
        </table>
    </div>

</div>
<script>
    let insideId;
    const dropdownToggle = document.getElementById("dropdownToggle");
    const dropdownMenu = document.getElementById("dropdownMenu");
    let bookString = document.getElementById("bookString");
    let createButton = document.getElementById("createButton")
    let confirmDelete = document.getElementById("confirmDelete")
    let modal = document.getElementById("modal")
    let createEditHeader = document.getElementById("createEditHeader")
    let confirmCreate = document.getElementById("confirmCreate")
    let confirmEdit = document.getElementById("confirmEdit")
    let createEditModal = document.getElementById("createEditModal")

    let quitModal = document.querySelectorAll(".quitModal");

    quitModal.forEach((quitModalItem) => {
        quitModalItem.addEventListener("click", function(){
            modal.classList.add("hidden");
            createEditModal.classList.add("hidden");
            authorString.innerHTML = "Select Book.."
            insideId = ""
    })
    });

    let blackModal = document.querySelectorAll(".blackModal");

    blackModal.forEach((blackModalItem) => {
        blackModalItem.addEventListener("click", function(){
            modal.classList.add("hidden");
            createEditModal.classList.add("hidden");
            authorString.innerHTML = "Select Book.."
            insideId = ""
    })
    });



    let deleteSvgs = document.querySelectorAll(".deleteSvg");
    deleteSvgs.forEach((deleteSvg) => {
        deleteSvg.addEventListener("click", function () {
            modal.id = deleteSvg.id
            modal.classList.toggle("hidden");
        });
    });

    let editReview = document.getElementById("editReview")
    let editScore = document.getElementById("editScore")
    let editUpVotes = document.getElementById("editUpVotes")

    let editSvgs = document.querySelectorAll(".editSvg");
    editSvgs.forEach((editSvg) => {
        editSvg.addEventListener("click", function () {
            modal.id = editSvg.id
            createEditHeader.innerHTML = "Modify the respective columns"
            confirmCreate.classList.add("hidden")
            confirmEdit.classList.remove("hidden")
            editReview.value = editSvg.attributes.review.value
            editScore.value = editSvg.attributes.score.value
            editUpVotes.value = editSvg.attributes.up_votes.value
            createEditModal.classList.toggle("hidden");
            authorString.innerHTML = editSvg.attributes.book.value
            insideId = editSvg.attributes.book_id.value
            dropdownMenu.classList.add("hidden")
        });
    });

    createButton.addEventListener("click", function () {
        createEditHeader.innerHTML = "Create new row"
        confirmCreate.classList.remove("hidden")
        confirmEdit.classList.add("hidden")
        editReview.value = ""
        editUpVotes.value = ""
        editScore.value = ""
        createEditModal.classList.toggle("hidden");
        dropdownMenu.classList.add("hidden")
    });

    confirmDelete.addEventListener("click", async function () {
        try {
            const response = await fetch("reviews/"+modal.id, {
                method: "DELETE"
            });

            if (response.ok) {
                const savedData = await response.json();
                location.reload();
            } else {
                alert("Error al guardar los datos en el servidor.");
            }
        } catch (error) {
            console.error("Error:", error);
        }
    });

    document.getElementById("confirmCreate").addEventListener("click", async (event) => {
            
            const editReview = document.getElementById("editReview").value
            const editScore = document.getElementById("editScore").value
            const editUpVotes = document.getElementById("editUpVotes").value
            const insideBook = { _id: insideId} 

            const requestData = {
                review: editReview,
                score: editScore,
                up_votes: editUpVotes,
                book: insideBook
            };
            try {
                const response = await fetch("reviews", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData),
                });

                if (response.ok) {
                    const savedData = await response.json();
                    location.reload();
                } else {
                    alert("Error al guardar los datos en el servidor.");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        });


        document.getElementById("confirmEdit").addEventListener("click", async (event) => {
            const editReview = document.getElementById("editReview").value
            const editScore = document.getElementById("editScore").value
            const editUpVotes = document.getElementById("editUpVotes").value
            const insideBook = { _id: insideId} 

            if (editScore > 5 || editScore < 0){
                alert("Remember.. the score must be between 0 and 5.")
            } else{
                const requestData = {
                    review: editReview,
                    score: editScore,
                    up_votes: editUpVotes,
                    book: insideBook
                };
                console.log(modal.id)
                try {
                    const response = await fetch("reviews/" + modal.id, {
                        method: "PUT",
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(requestData),
                    });
    
                    if (response.ok) {
                        const savedData = await response.json();
                        location.reload();
                    } else {
                        alert("Error al guardar los datos en el servidor.");
                    }
                } catch (error) {
                    console.error("Error:", error);
                }
            }

        });

        
    dropdownToggle.addEventListener("click", function(){
        dropdownMenu.classList.toggle("hidden");
    })

    let authorOption = document.querySelectorAll(".authorOption");

        authorOption.forEach((authorOptionItem) => {
            authorOptionItem.addEventListener("click", function(){
                dropdownMenu.classList.toggle("hidden");
                authorString.innerHTML = authorOptionItem.innerHTML
                insideId = authorOptionItem.id
        })
    });

</script>